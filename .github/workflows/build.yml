name: Build and Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-latest
          - platform: windows-latest
          - platform: macos-latest
    runs-on: ${{ matrix.platform }}

    env:
      VITE_DEV_MODE: ${{ vars.VITE_DEV_MODE }}
      VITE_PROD_MODE: ${{ vars.VITE_PROD_MODE }}
      VITE_APP_NAME: ${{ vars.VITE_APP_NAME }}
      VITE_APP_VERSION: ${{ vars.VITE_APP_VERSION }}
      VITE_DOCS_URL: ${{ vars.VITE_DOCS_URL }}
      VITE_WALLET_CHECK_TIMEOUT_MS: ${{ vars.VITE_WALLET_CHECK_TIMEOUT_MS }}
      VITE_AMADEUS_NODE_API_URL: ${{ vars.VITE_AMADEUS_NODE_API_URL }}
      VITE_AMADEUS_URI_PREFIX: ${{ vars.VITE_AMADEUS_URI_PREFIX }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.12.0"
          cache: "pnpm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app
        run: pnpm tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: amadeus-wallet-${{ matrix.platform }}
          path: src-tauri/target/release/bundle/

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: amadeus-wallet-ubuntu-latest
          path: artifacts/linux

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: amadeus-wallet-windows-latest
          path: artifacts/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: amadeus-wallet-macos-latest
          path: artifacts/macos

      - name: Ensure release tag exists
        run: |
          TAG="v${{ vars.VITE_APP_VERSION }}"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
          fi

      # Delete existing release (keeps tag). Use API so we never call "delete release asset" (which 404s).
      - name: Delete existing release for tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: v${{ vars.VITE_APP_VERSION }}
        run: |
          RESP=$(curl -sS -w "\n%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG}")
          HTTP_BODY=$(echo "$RESP" | head -n -1)
          HTTP_CODE=$(echo "$RESP" | tail -n 1)
          if [ "$HTTP_CODE" = "200" ]; then
            RELEASE_ID=$(echo "$HTTP_BODY" | jq -r '.id // empty')
            if [ -n "$RELEASE_ID" ]; then
              curl -sS -X DELETE \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID" || true
            fi
          fi

      # Create release and upload assets via API only (no third-party action, no "delete asset" calls).
      - name: Create release and upload assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: v${{ vars.VITE_APP_VERSION }}
        run: |
          BODY="**Build** from commit ${{ github.sha }}
          Triggered by push to \`main\`."
          RELEASE_JSON=$(jq -n \
            --arg tag_name "$TAG" \
            --arg name "${{ vars.VITE_APP_NAME }} $TAG" \
            --arg body "$BODY" \
            '{tag_name:$tag_name,name:$name,body:$body,draft:false}')
          RESP=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -d "$RELEASE_JSON")
          HTTP_BODY=$(echo "$RESP" | head -n -1)
          HTTP_CODE=$(echo "$RESP" | tail -n 1)
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Create release failed (HTTP $HTTP_CODE):"
            echo "$HTTP_BODY" | jq . 2>/dev/null || echo "$HTTP_BODY"
            exit 1
          fi
          CREATED="$HTTP_BODY"
          UPLOAD_URL=$(echo "$CREATED" | jq -r '.upload_url | split("{")[0]')
          # Upload only installer/archive assets (not every file in bundle)
          while IFS= read -r -d '' path; do
            name=$(echo "$path" | sed 's|^artifacts/||' | tr '/' '-')
            echo "Uploading $name..."
            curl -sS -f -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/octet-stream" \
              "$UPLOAD_URL?name=$(echo -n "$name" | jq -sRr @uri)" \
              --data-binary "@$path"
          done < <(find artifacts -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.tar.gz" -o -name "*.tar.xz" \) -print0)
